#include <stm32f4xx_hal.h>
#include <stm32f4xx_hal_i2c.h>

#include "SSD1306.h"

#define FONT_WIDTH 8
#define FONT_HEIGHT 8
static uint8_t font[] =
{
		// 08UKRSTD
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x7E, 0x7F, 0x01, 0x49, 0x4F, 0x7E, 0x30, 0x00,
	    0x7E, 0xFF, 0xEB, 0xCF, 0xCF, 0xEB, 0xFF, 0x7E,
	    0x0E, 0x1F, 0x3F, 0x7E, 0x3F, 0x1F, 0x0E, 0x00,
	    0x08, 0x1C, 0x3E, 0x7F, 0x3E, 0x1C, 0x08, 0x00,
	    0x18, 0xBA, 0xFF, 0xFF, 0xFF, 0xBA, 0x18, 0x00,
	    0x10, 0xB8, 0xFC, 0xFF, 0xFC, 0xB8, 0x10, 0x00,
	    0x00, 0x00, 0x18, 0x3C, 0x3C, 0x18, 0x00, 0x00,
	    0xFF, 0xFF, 0xE7, 0xC3, 0xC3, 0xE7, 0xFF, 0xFF,
	    0x00, 0x3C, 0x66, 0x42, 0x42, 0x66, 0x3C, 0x00,
	    0xFF, 0xC3, 0x99, 0xBD, 0xBD, 0x99, 0xC3, 0xFF,
	    0x70, 0xF8, 0x88, 0x88, 0xFD, 0x7F, 0x07, 0x0F,
	    0x00, 0x4E, 0x5F, 0xF1, 0xF1, 0x5F, 0x4E, 0x00,
	    0xC0, 0xE0, 0xFF, 0x7F, 0x05, 0x05, 0x07, 0x07,
	    0xC0, 0xFF, 0x7F, 0x05, 0x05, 0x65, 0x7F, 0x3F,
	    0x99, 0x5A, 0x3C, 0xE7, 0xE7, 0x3C, 0x5A, 0x99,
	    0x7F, 0x3E, 0x3E, 0x1C, 0x1C, 0x08, 0x08, 0x00,
	    0x08, 0x08, 0x1C, 0x1C, 0x3E, 0x3E, 0x7F, 0x00,
	    0x00, 0x24, 0x66, 0xFF, 0xFF, 0x66, 0x24, 0x00,
	    0x00, 0x5F, 0x5F, 0x00, 0x00, 0x5F, 0x5F, 0x00,
	    0x06, 0x0F, 0x09, 0x7F, 0x7F, 0x01, 0x7F, 0x7F,
	    0x40, 0xDA, 0xBF, 0xA5, 0xFD, 0x59, 0x03, 0x02,
	    0x00, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x00,
	    0x80, 0x94, 0xB6, 0xFF, 0xFF, 0xB6, 0x94, 0x80,
	    0x00, 0x04, 0x06, 0x7F, 0x7F, 0x06, 0x04, 0x00,
	    0x00, 0x10, 0x30, 0x7F, 0x7F, 0x30, 0x10, 0x00,
	    0x08, 0x08, 0x08, 0x2A, 0x3E, 0x1C, 0x08, 0x00,
	    0x08, 0x1C, 0x3E, 0x2A, 0x08, 0x08, 0x08, 0x00,
	    0x3C, 0x3C, 0x20, 0x20, 0x20, 0x20, 0x20, 0x00,
	    0x08, 0x1C, 0x3E, 0x08, 0x08, 0x3E, 0x1C, 0x08,
	    0x30, 0x38, 0x3C, 0x3E, 0x3E, 0x3C, 0x38, 0x30,
	    0x06, 0x0E, 0x1E, 0x3E, 0x3E, 0x1E, 0x0E, 0x06,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x06, 0x5F, 0x5F, 0x06, 0x00, 0x00, 0x00,
	    0x00, 0x07, 0x07, 0x00, 0x07, 0x07, 0x00, 0x00,
	    0x14, 0x7F, 0x7F, 0x14, 0x7F, 0x7F, 0x14, 0x00,
	    0x24, 0x2E, 0x6B, 0x6B, 0x3A, 0x12, 0x00, 0x00,
	    0x46, 0x66, 0x30, 0x18, 0x0C, 0x66, 0x62, 0x00,
	    0x30, 0x7A, 0x4F, 0x5D, 0x37, 0x7A, 0x48, 0x00,
	    0x04, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x1C, 0x3E, 0x63, 0x41, 0x00, 0x00, 0x00,
	    0x00, 0x41, 0x63, 0x3E, 0x1C, 0x00, 0x00, 0x00,
	    0x08, 0x2A, 0x3E, 0x1C, 0x1C, 0x3E, 0x2A, 0x08,
	    0x08, 0x08, 0x3E, 0x3E, 0x08, 0x08, 0x00, 0x00,
	    0x00, 0x80, 0xE0, 0x60, 0x00, 0x00, 0x00, 0x00,
	    0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00,
	    0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x00,
	    0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x01, 0x00,
	    0x3E, 0x7F, 0x71, 0x59, 0x4D, 0x7F, 0x3E, 0x00,
	    0x40, 0x42, 0x7F, 0x7F, 0x40, 0x40, 0x00, 0x00,
	    0x62, 0x73, 0x59, 0x49, 0x6F, 0x66, 0x00, 0x00,
	    0x22, 0x63, 0x49, 0x49, 0x7F, 0x36, 0x00, 0x00,
	    0x18, 0x1C, 0x16, 0x53, 0x7F, 0x7F, 0x50, 0x00,
	    0x27, 0x67, 0x45, 0x45, 0x7D, 0x39, 0x00, 0x00,
	    0x3C, 0x7E, 0x4B, 0x49, 0x79, 0x30, 0x00, 0x00,
	    0x03, 0x03, 0x71, 0x79, 0x0F, 0x07, 0x00, 0x00,
	    0x36, 0x7F, 0x49, 0x49, 0x7F, 0x36, 0x00, 0x00,
	    0x06, 0x4F, 0x49, 0x69, 0x3F, 0x1E, 0x00, 0x00,
	    0x00, 0x00, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x80, 0xE6, 0x66, 0x00, 0x00, 0x00, 0x00,
	    0x08, 0x1C, 0x36, 0x63, 0x41, 0x00, 0x00, 0x00,
	    0x24, 0x24, 0x24, 0x24, 0x24, 0x24, 0x00, 0x00,
	    0x00, 0x41, 0x63, 0x36, 0x1C, 0x08, 0x00, 0x00,
	    0x02, 0x03, 0x51, 0x59, 0x0F, 0x06, 0x00, 0x00,
	    0x3E, 0x7F, 0x41, 0x5D, 0x5D, 0x1F, 0x1E, 0x00,
	    0x7C, 0x7E, 0x13, 0x13, 0x7E, 0x7C, 0x00, 0x00,
	    0x41, 0x7F, 0x7F, 0x49, 0x49, 0x7F, 0x36, 0x00,
	    0x1C, 0x3E, 0x63, 0x41, 0x41, 0x63, 0x22, 0x00,
	    0x41, 0x7F, 0x7F, 0x41, 0x63, 0x3E, 0x1C, 0x00,
	    0x41, 0x7F, 0x7F, 0x49, 0x5D, 0x41, 0x63, 0x00,
	    0x41, 0x7F, 0x7F, 0x49, 0x1D, 0x01, 0x03, 0x00,
	    0x1C, 0x3E, 0x63, 0x41, 0x51, 0x73, 0x72, 0x00,
	    0x7F, 0x7F, 0x08, 0x08, 0x7F, 0x7F, 0x00, 0x00,
	    0x00, 0x41, 0x7F, 0x7F, 0x41, 0x00, 0x00, 0x00,
	    0x30, 0x70, 0x40, 0x41, 0x7F, 0x3F, 0x01, 0x00,
	    0x41, 0x7F, 0x7F, 0x08, 0x1C, 0x77, 0x63, 0x00,
	    0x41, 0x7F, 0x7F, 0x41, 0x40, 0x60, 0x70, 0x00,
	    0x7F, 0x7F, 0x0E, 0x1C, 0x0E, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x06, 0x0C, 0x18, 0x7F, 0x7F, 0x00,
	    0x1C, 0x3E, 0x63, 0x41, 0x63, 0x3E, 0x1C, 0x00,
	    0x41, 0x7F, 0x7F, 0x49, 0x09, 0x0F, 0x06, 0x00,
	    0x1E, 0x3F, 0x21, 0x71, 0x7F, 0x5E, 0x00, 0x00,
	    0x41, 0x7F, 0x7F, 0x09, 0x19, 0x7F, 0x66, 0x00,
	    0x26, 0x6F, 0x4D, 0x59, 0x73, 0x32, 0x00, 0x00,
	    0x03, 0x41, 0x7F, 0x7F, 0x41, 0x03, 0x00, 0x00,
	    0x7F, 0x7F, 0x40, 0x40, 0x7F, 0x7F, 0x00, 0x00,
	    0x1F, 0x3F, 0x60, 0x60, 0x3F, 0x1F, 0x00, 0x00,
	    0x7F, 0x7F, 0x30, 0x18, 0x30, 0x7F, 0x7F, 0x00,
	    0x43, 0x67, 0x3C, 0x18, 0x3C, 0x67, 0x43, 0x00,
	    0x07, 0x4F, 0x78, 0x78, 0x4F, 0x07, 0x00, 0x00,
	    0x47, 0x63, 0x71, 0x59, 0x4D, 0x67, 0x73, 0x00,
	    0x00, 0x7F, 0x7F, 0x41, 0x41, 0x00, 0x00, 0x00,
	    0x01, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00,
	    0x00, 0x41, 0x41, 0x7F, 0x7F, 0x00, 0x00, 0x00,
	    0x08, 0x0C, 0x06, 0x03, 0x06, 0x0C, 0x08, 0x00,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x00, 0x00, 0x03, 0x07, 0x04, 0x00, 0x00, 0x00,
	    0x20, 0x74, 0x54, 0x54, 0x3C, 0x78, 0x40, 0x00,
	    0x41, 0x7F, 0x3F, 0x48, 0x48, 0x78, 0x30, 0x00,
	    0x38, 0x7C, 0x44, 0x44, 0x6C, 0x28, 0x00, 0x00,
	    0x30, 0x78, 0x48, 0x49, 0x3F, 0x7F, 0x40, 0x00,
	    0x38, 0x7C, 0x54, 0x54, 0x5C, 0x18, 0x00, 0x00,
	    0x48, 0x7E, 0x7F, 0x49, 0x03, 0x02, 0x00, 0x00,
	    0x98, 0xBC, 0xA4, 0xA4, 0xF8, 0x7C, 0x04, 0x00,
	    0x41, 0x7F, 0x7F, 0x08, 0x04, 0x7C, 0x78, 0x00,
	    0x00, 0x44, 0x7D, 0x7D, 0x40, 0x00, 0x00, 0x00,
	    0x60, 0xE0, 0x80, 0x80, 0xFD, 0x7D, 0x00, 0x00,
	    0x41, 0x7F, 0x7F, 0x10, 0x38, 0x6C, 0x44, 0x00,
	    0x00, 0x41, 0x7F, 0x7F, 0x40, 0x00, 0x00, 0x00,
	    0x7C, 0x7C, 0x18, 0x38, 0x1C, 0x7C, 0x78, 0x00,
	    0x7C, 0x7C, 0x04, 0x04, 0x7C, 0x78, 0x00, 0x00,
	    0x38, 0x7C, 0x44, 0x44, 0x7C, 0x38, 0x00, 0x00,
	    0x84, 0xFC, 0xF8, 0xA4, 0x24, 0x3C, 0x18, 0x00,
	    0x18, 0x3C, 0x24, 0xA4, 0xF8, 0xFC, 0x84, 0x00,
	    0x44, 0x7C, 0x78, 0x4C, 0x04, 0x1C, 0x18, 0x00,
	    0x48, 0x5C, 0x54, 0x54, 0x74, 0x24, 0x00, 0x00,
	    0x00, 0x04, 0x3E, 0x7F, 0x44, 0x24, 0x00, 0x00,
	    0x3C, 0x7C, 0x40, 0x40, 0x3C, 0x7C, 0x40, 0x00,
	    0x1C, 0x3C, 0x60, 0x60, 0x3C, 0x1C, 0x00, 0x00,
	    0x3C, 0x7C, 0x70, 0x38, 0x70, 0x7C, 0x3C, 0x00,
	    0x44, 0x6C, 0x38, 0x10, 0x38, 0x6C, 0x44, 0x00,
	    0x9C, 0xBC, 0xA0, 0xA0, 0xFC, 0x7C, 0x00, 0x00,
	    0x4C, 0x64, 0x74, 0x5C, 0x4C, 0x64, 0x00, 0x00,
	    0x08, 0x08, 0x3E, 0x77, 0x41, 0x41, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x77, 0x77, 0x00, 0x00, 0x00,
	    0x41, 0x41, 0x77, 0x3E, 0x08, 0x08, 0x00, 0x00,
	    0x02, 0x03, 0x01, 0x03, 0x02, 0x03, 0x01, 0x00,
	    0x70, 0x78, 0x4C, 0x46, 0x4C, 0x78, 0x70, 0x00,
	    0x70, 0x78, 0x1C, 0x16, 0x13, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x49, 0x49, 0x49, 0x79, 0x30, 0x00,
	    0x7F, 0x7F, 0x49, 0x49, 0x4F, 0x7E, 0x30, 0x00,
	    0x7F, 0x7F, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00,
	    0xC0, 0xFF, 0x7F, 0x41, 0x41, 0x7F, 0xFF, 0xC0,
	    0x7F, 0x7F, 0x49, 0x49, 0x49, 0x41, 0x40, 0x00,
	    0x63, 0x77, 0x14, 0x7F, 0x7F, 0x14, 0x77, 0x63,
	    0x20, 0x62, 0x4B, 0x49, 0x49, 0x7F, 0x36, 0x00,
	    0x7F, 0x7F, 0x30, 0x18, 0x0C, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x30, 0x19, 0x0C, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x08, 0x0C, 0x1E, 0x73, 0x61, 0x00,
	    0x60, 0x70, 0x18, 0x0C, 0x06, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x06, 0x0C, 0x06, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x08, 0x08, 0x08, 0x7F, 0x7F, 0x00,
	    0x3E, 0x7F, 0x41, 0x41, 0x41, 0x7F, 0x3E, 0x00,
	    0x7F, 0x7F, 0x01, 0x01, 0x01, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x09, 0x09, 0x09, 0x0F, 0x06, 0x00,
	    0x3E, 0x7F, 0x41, 0x41, 0x41, 0x63, 0x22, 0x00,
	    0x01, 0x01, 0x7F, 0x7F, 0x01, 0x01, 0x00, 0x00,
	    0x27, 0x6F, 0x48, 0x48, 0x48, 0x7F, 0x3F, 0x00,
	    0x1C, 0x3E, 0x22, 0x7F, 0x7F, 0x22, 0x3E, 0x1C,
	    0x41, 0x63, 0x36, 0x1C, 0x1C, 0x36, 0x63, 0x41,
	    0x7F, 0x7F, 0x40, 0x40, 0x7F, 0xFF, 0xC0, 0x00,
	    0x07, 0x0F, 0x08, 0x08, 0x08, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x40, 0x7F, 0x40, 0x7F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x40, 0x7F, 0x40, 0x7F, 0xFF, 0xC0,
	    0x01, 0x01, 0x7F, 0x7F, 0x48, 0x48, 0x78, 0x30,
	    0x7F, 0x7F, 0x48, 0x78, 0x30, 0x4F, 0x7F, 0x00,
	    0x7F, 0x7F, 0x48, 0x48, 0x48, 0x78, 0x30, 0x00,
	    0x22, 0x63, 0x41, 0x49, 0x49, 0x7F, 0x3E, 0x00,
	    0x7F, 0x7F, 0x08, 0x3E, 0x7F, 0x41, 0x7F, 0x3E,
	    0x46, 0x6F, 0x39, 0x19, 0x09, 0x7F, 0x7F, 0x00,
	    0x20, 0x74, 0x54, 0x54, 0x7C, 0x78, 0x40, 0x00,
	    0x3C, 0x7E, 0x4A, 0x4A, 0x7A, 0x31, 0x00, 0x00,
	    0x7C, 0x7C, 0x54, 0x54, 0x5C, 0x68, 0x20, 0x00,
	    0x7C, 0x7C, 0x04, 0x04, 0x04, 0x04, 0x00, 0x00,
	    0xC0, 0xFC, 0x7C, 0x44, 0x44, 0x7C, 0xFC, 0xC0,
	    0x38, 0x7C, 0x54, 0x54, 0x5C, 0x58, 0x00, 0x00,
	    0x44, 0x6C, 0x28, 0x7C, 0x7C, 0x28, 0x6C, 0x44,
	    0x28, 0x6C, 0x44, 0x54, 0x7C, 0x28, 0x00, 0x00,
	    0x7C, 0x7C, 0x20, 0x10, 0x7C, 0x7C, 0x00, 0x00,
	    0x7C, 0x7C, 0x21, 0x11, 0x7C, 0x7C, 0x00, 0x00,
	    0x7C, 0x7C, 0x10, 0x18, 0x6C, 0x64, 0x00, 0x00,
	    0x40, 0x60, 0x30, 0x18, 0x0C, 0x7C, 0x7C, 0x00,
	    0x7C, 0x7C, 0x08, 0x10, 0x08, 0x7C, 0x7C, 0x00,
	    0x7C, 0x7C, 0x10, 0x10, 0x7C, 0x7C, 0x00, 0x00,
	    0x38, 0x7C, 0x44, 0x44, 0x7C, 0x38, 0x00, 0x00,
	    0x7C, 0x7C, 0x04, 0x04, 0x7C, 0x7C, 0x00, 0x00,
	    0xAA, 0x00, 0x55, 0x00, 0xAA, 0x00, 0x55, 0x00,
	    0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55, 0xAA, 0x55,
	    0xDD, 0xFF, 0xAA, 0x77, 0xDD, 0xAA, 0xFF, 0x77,
	    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00,
	    0x10, 0x10, 0x10, 0xFF, 0xFF, 0x00, 0x00, 0x00,
	    0x14, 0x14, 0x14, 0xFF, 0xFF, 0x00, 0x00, 0x00,
	    0x10, 0x10, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00,
	    0x10, 0x10, 0xF0, 0xF0, 0x10, 0xF0, 0xF0, 0x00,
	    0x14, 0x14, 0x14, 0xFC, 0xFC, 0x00, 0x00, 0x00,
	    0x14, 0x14, 0xF7, 0xF7, 0x00, 0xFF, 0xFF, 0x00,
	    0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00,
	    0x14, 0x14, 0xF4, 0xF4, 0x04, 0xFC, 0xFC, 0x00,
	    0x14, 0x14, 0x17, 0x17, 0x10, 0x1F, 0x1F, 0x00,
	    0x10, 0x10, 0x1F, 0x1F, 0x10, 0x1F, 0x1F, 0x00,
	    0x14, 0x14, 0x14, 0x1F, 0x1F, 0x00, 0x00, 0x00,
	    0x10, 0x10, 0x10, 0xF0, 0xF0, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x1F, 0x1F, 0x10, 0x10, 0x10,
	    0x10, 0x10, 0x10, 0x1F, 0x1F, 0x10, 0x10, 0x10,
	    0x10, 0x10, 0x10, 0xF0, 0xF0, 0x10, 0x10, 0x10,
	    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x10, 0x10, 0x10,
	    0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10,
	    0x10, 0x10, 0x10, 0xFF, 0xFF, 0x10, 0x10, 0x10,
	    0x00, 0x00, 0x00, 0xFF, 0xFF, 0x14, 0x14, 0x14,
	    0x00, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x10,
	    0x00, 0x00, 0x1F, 0x1F, 0x10, 0x17, 0x17, 0x14,
	    0x00, 0x00, 0xFC, 0xFC, 0x04, 0xF4, 0xF4, 0x14,
	    0x14, 0x14, 0x17, 0x17, 0x10, 0x17, 0x17, 0x14,
	    0x14, 0x14, 0xF4, 0xF4, 0x04, 0xF4, 0xF4, 0x14,
	    0x00, 0x00, 0xFF, 0xFF, 0x00, 0xF7, 0xF7, 0x14,
	    0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14,
	    0x14, 0x14, 0xF7, 0xF7, 0x00, 0xF7, 0xF7, 0x14,
	    0x14, 0x14, 0x14, 0x17, 0x17, 0x14, 0x14, 0x14,
	    0x10, 0x10, 0x1F, 0x1F, 0x10, 0x1F, 0x1F, 0x10,
	    0x14, 0x14, 0x14, 0xF4, 0xF4, 0x14, 0x14, 0x14,
	    0x10, 0x10, 0xF0, 0xF0, 0x10, 0xF0, 0xF0, 0x10,
	    0x00, 0x00, 0x1F, 0x1F, 0x10, 0x1F, 0x1F, 0x10,
	    0x00, 0x00, 0x00, 0x1F, 0x1F, 0x14, 0x14, 0x14,
	    0x00, 0x00, 0x00, 0xFC, 0xFC, 0x14, 0x14, 0x14,
	    0x00, 0x00, 0xF0, 0xF0, 0x10, 0xF0, 0xF0, 0x10,
	    0x10, 0x10, 0xFF, 0xFF, 0x10, 0xFF, 0xFF, 0x10,
	    0x14, 0x14, 0x14, 0xFF, 0xFF, 0x14, 0x14, 0x14,
	    0x10, 0x10, 0x10, 0x1F, 0x1F, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0xF0, 0xF0, 0x10, 0x10, 0x10,
	    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
	    0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF,
	    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
	    0xFC, 0xFC, 0x24, 0x24, 0x3C, 0x18, 0x00, 0x00,
	    0x38, 0x7C, 0x44, 0x44, 0x6C, 0x28, 0x00, 0x00,
	    0x04, 0x04, 0x7C, 0x7C, 0x04, 0x04, 0x00, 0x00,
	    0x4C, 0xDC, 0x90, 0x90, 0xFC, 0x7C, 0x00, 0x00,
	    0x18, 0x3C, 0x24, 0xFE, 0xFE, 0x24, 0x3C, 0x18,
	    0x44, 0x6C, 0x38, 0x10, 0x38, 0x6C, 0x44, 0x00,
	    0x7C, 0x7C, 0x40, 0x40, 0x7C, 0xFC, 0xC0, 0x00,
	    0x0C, 0x1C, 0x10, 0x10, 0x7C, 0x7C, 0x00, 0x00,
	    0x7C, 0x7C, 0x40, 0x7C, 0x40, 0x7C, 0x7C, 0x00,
	    0x7C, 0x7C, 0x40, 0x7C, 0x40, 0x7C, 0xFC, 0xC0,
	    0x04, 0x04, 0x7C, 0x7C, 0x50, 0x50, 0x70, 0x20,
	    0x7C, 0x7C, 0x50, 0x70, 0x20, 0x5C, 0x7C, 0x00,
	    0x7C, 0x7C, 0x50, 0x50, 0x70, 0x20, 0x00, 0x00,
	    0x28, 0x6C, 0x44, 0x54, 0x54, 0x7C, 0x38, 0x00,
	    0x7C, 0x7C, 0x10, 0x38, 0x7C, 0x44, 0x7C, 0x38,
	    0x48, 0x7C, 0x34, 0x14, 0x7C, 0x7C, 0x00, 0x00,
	    0x7E, 0x7F, 0x4B, 0x4A, 0x43, 0x43, 0x42, 0x00,
	    0x38, 0x7D, 0x55, 0x54, 0x5D, 0x59, 0x00, 0x00,
	    0x7E, 0x7E, 0x02, 0x02, 0x02, 0x01, 0x00, 0x00,
	    0x7C, 0x7C, 0x04, 0x04, 0x04, 0x02, 0x00, 0x00,
	    0x3E, 0x7F, 0x49, 0x49, 0x41, 0x63, 0x22, 0x00,
	    0x38, 0x7C, 0x54, 0x54, 0x44, 0x6C, 0x28, 0x00,
	    0x00, 0x41, 0x7F, 0x7F, 0x41, 0x00, 0x00, 0x00,
	    0x00, 0x44, 0x7D, 0x7D, 0x40, 0x00, 0x00, 0x00,
	    0x01, 0x41, 0x7E, 0x7E, 0x41, 0x01, 0x00, 0x00,
	    0x01, 0x45, 0x7C, 0x7C, 0x41, 0x01, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x10, 0x10, 0x00, 0x00, 0x00,
	    0x10, 0x30, 0x70, 0xC0, 0xFF, 0xFF, 0x01, 0x01,
	    0x7F, 0x06, 0x0C, 0x18, 0x7F, 0x00, 0x03, 0x03,
	    0x63, 0x77, 0x5D, 0x49, 0x41, 0x41, 0x63, 0x00,
	    0x00, 0x00, 0x3C, 0x3C, 0x3C, 0x3C, 0x00, 0x00,
	    0x00, 0xDA, 0xBF, 0xA5, 0xFD, 0x5B, 0x00, 0x00,
		0x00
};

#define SSD1306_CMD_SETCONTRAST 		0x81
#define SSD1306_CMD_DISPLAYALLON_RESUME 0xA4
#define SSD1306_CMD_DISPLAYALLON 		0xA5
#define SSD1306_CMD_NORMALDISPLAY 		0xA6
#define SSD1306_CMD_INVERTDISPLAY 		0xA7
#define SSD1306_CMD_DISPLAYOFF 			0xAE
#define SSD1306_CMD_DISPLAYON 			0xAF
#define SSD1306_CMD_SETDISPLAYOFFSET 	0xD3
#define SSD1306_CMD_SETCOMPINS 			0xDA
#define SSD1306_CMD_SETVCOMDETECT 		0xDB
#define SSD1306_CMD_SETDISPLAYCLOCKDIV 	0xD5
#define SSD1306_CMD_SETPRECHARGE 		0xD9
#define SSD1306_CMD_SETMULTIPLEX 		0xA8
#define SSD1306_CMD_SETLOWCOLUMN 		0x00
#define SSD1306_CMD_SETHIGHCOLUMN 		0x10
#define SSD1306_CMD_SETSTARTLINE 		0x40
#define SSD1306_CMD_MEMORYMODE 			0x20
#define SSD1306_CMD_COLUMNADDR 			0x21
#define SSD1306_CMD_PAGEADDR 			0x22
#define SSD1306_CMD_COMSCANINC 			0xC0
#define SSD1306_CMD_COMSCANDEC 			0xC8
#define SSD1306_CMD_SEGREMAP 			0xA0
#define SSD1306_CMD_CHARGEPUMP 			0x8D
#define SSD1306_CMD_SWITCHCAPVCC 		0x02
#define SSD1306_CMD_NOP 				0xE3
#define SSD1306_CMD_SETPAGESTARTADDR	0xB0

#define SSD1306_CTL_COMMAND_STREAM		0x00
#define SSD1306_CTL_DATA_STREAM			0x40
#define SSD1306_CTL_SINGLE_CMD_BYTE		0x80
#define SSD1306_CTL_SINGLE_DATA_BYTE	0xC0

void SSD1306_cb_error(SSD1306_ctx_t *ctx)
{
	ctx->cb_error_cnt++;
}

void SSD1306_cb_complete(SSD1306_ctx_t *ctx)
{
	uint32_t ch, i;
	uint32_t *fnt, *fb, inv;

	ctx->cb_complete_cnt++;
	switch(ctx->state)
	{
		case SSD1306_FSM_SETPAGECOLROW:

			/* setup buffer, set proper page */
			ctx->dma_buf[0] = SSD1306_CTL_COMMAND_STREAM;
			// Set Page Start Address for Page Addressing Mode
			ctx->dma_buf[1] = SSD1306_CMD_SETPAGESTARTADDR | ctx->current_page,
			// Set Lower Column Start Address for Page Addressing Mode
			ctx->dma_buf[2] = SSD1306_CMD_SETLOWCOLUMN | ctx->column_shift;
			// Set Higher Column Start Address for Page Addressing Mode
			ctx->dma_buf[3] = SSD1306_CMD_SETHIGHCOLUMN | 0;

			/* send it */
			HAL_I2C_Master_Transmit_DMA(ctx->hi2c, ctx->addr << 1, ctx->dma_buf, 4);

			/* next we need to start transfering page */
			ctx->state = SSD1306_FSM_TRANSFER_PAGE;

			break;

		case SSD1306_FSM_TRANSFER_PAGE:

			/* prepare bits buffer to send */
			ctx->dma_buf[0] = SSD1306_CTL_DATA_STREAM;
			fb = (uint32_t*)(ctx->dma_buf + 1);
			for(i = 0; i < 16; i++)
			{
				ch = ctx->screen->fb[ctx->current_page][i];
				if(ctx->screen->blink && (ch & (TEXT_SCREEN_ATTR_BLINK << 8)))
					ch = (ch & 0xFF00) | ' ';
				inv = (ch & (TEXT_SCREEN_ATTR_INVERT << 8)) ? 0xFFFFFFFF : 0x00000000;
				fnt = (uint32_t*)(font + (ch & 0x00FF) * FONT_WIDTH);
				*fb = fnt[0] ^ inv; fb++;
				*fb = fnt[1] ^ inv; fb++;
			}

			/* send it */
			HAL_I2C_Master_Transmit_DMA(ctx->hi2c, ctx->addr << 1, ctx->dma_buf, 16 * 8 + 1);

			/* increment page number */
			ctx->current_page++;

			if(ctx->current_page == (ctx->height / 8))
			{
				ctx->current_page = 0;
				ctx->state = SSD1306_FSM_IDLE;
			}
			else
				ctx->state = SSD1306_FSM_SETPAGECOLROW;
			break;

		case SSD1306_FSM_IDLE:

			ctx->state = SSD1306_FSM_READY;
			SSD1306_cb_complete(ctx);
			break;
	}
}
/*
static inline int SSD1306_CMD(SSD1306_ctx_t *ctx, uint8_t C)
{
	uint8_t buf[] = {SSD1306_CTL_COMMAND_STREAM, C};
    return HAL_I2C_Master_Transmit(ctx->hi2c, ctx->addr << 1, buf, 2, 100);
};
*/
int SSD1306_setup(SSD1306_ctx_t *ctx)
{
	uint8_t buf[] = {
		SSD1306_CTL_COMMAND_STREAM,

		// Figure 2 : Software Initialization Flow Chart
		/* primary setup */

		SSD1306_CMD_DISPLAYOFF, // turn off display

		/* Set Multiplex Ratio */
		SSD1306_CMD_SETMULTIPLEX,
		(ctx->height == 32) ?
			0x1F				//128×32 (N=31 + 1)
			:
			0x3F,				//128×64 (RESET)

		/* 10.1.15 Set Display Offset */
		SSD1306_CMD_SETDISPLAYOFFSET,
		0x00,

		/* Set Display Start Line */
		SSD1306_CMD_SETSTARTLINE | 0x00,

		/* Set Segment Re-map */
		SSD1306_CMD_SEGREMAP | 0x1,	// column address 127 is mapped to SEG0, Flip?

		/* Set COM Output Scan Direction */
		SSD1306_CMD_COMSCANDEC,		// remapped mode. Scan from COM[N-1] to COM0 Where N is the Multiplex ratio

		/* Set COM Pins Hardware Configuration */
		SSD1306_CMD_SETCOMPINS,
		(ctx->height == 32) ?
			// A[4]=0b, Sequential COM pin configuration
			// A[5]=0b(RESET), Disable COM Left/Right remap
			0x02 	//128×32
			:
			// A[4]=1b(RESET), Alternative COM pin configuration
			// A[5]=0b(RESET), Disable COM Left/Right remap
			0x12,	//128×64

		/* Set Contrast Control for BANK0 */
		SSD1306_CMD_SETCONTRAST,
		0xCF, // Max contrast (RESET = 7Fh )

		/* Entire Display ON */
		SSD1306_CMD_DISPLAYALLON_RESUME, // Resume to RAM content display (RESET)

		/* Set Normal/Inverse Display */
		SSD1306_CMD_NORMALDISPLAY,

		/* Set Display Clock Divide Ratio/Oscillator Frequency */
		SSD1306_CMD_SETDISPLAYCLOCKDIV,
		0x80,	// Oscillator Frequency = [1]  , Divide ratio = [0] + 1

		/* Charge Pump Setting */
		SSD1306_CMD_CHARGEPUMP,
		0x14,	// Enable charge pump during display on

		/* Set Memory Addressing Mode */
		SSD1306_CMD_MEMORYMODE,
		0x02,	// Page addressing mode

		/* Set Pre-charge Period */
		SSD1306_CMD_SETPRECHARGE,
		0xF1,

		/* Set VCOMH Deselect Level */
		SSD1306_CMD_SETVCOMDETECT,
		0x40,	//0x40

		/* Set Display ON/OFF */
		SSD1306_CMD_DISPLAYON,	// Display ON in normal mode
	};

	return HAL_I2C_Master_Transmit(ctx->hi2c, ctx->addr << 1, buf, sizeof(buf), 100);
}

void SSD1306_run(SSD1306_ctx_t *ctx)
{
	// register callbacks
	HAL_I2C_RegisterCallback(ctx->hi2c, HAL_I2C_MASTER_TX_COMPLETE_CB_ID, ctx->cb_complete_proc);
	HAL_I2C_RegisterCallback(ctx->hi2c, HAL_I2C_ERROR_CB_ID, ctx->cb_error_proc);
	HAL_I2C_RegisterCallback(ctx->hi2c, HAL_I2C_ABORT_CB_ID, ctx->cb_error_proc);
	HAL_I2C_RegisterCallback(ctx->hi2c, HAL_I2C_MEM_RX_COMPLETE_CB_ID, ctx->cb_error_proc);
	HAL_I2C_RegisterCallback(ctx->hi2c, HAL_I2C_MEM_TX_COMPLETE_CB_ID, ctx->cb_error_proc);
	HAL_I2C_RegisterCallback(ctx->hi2c, HAL_I2C_LISTEN_COMPLETE_CB_ID, ctx->cb_error_proc);

	// run loop
	SSD1306_cb_complete(ctx);
}

void SSD1306_init(SSD1306_ctx_t *ctx, I2C_HandleTypeDef *hi2c, uint8_t addr, uint8_t height, uint8_t column_shift, TextScreen_t* screen)
{
	ctx->addr = addr;
	ctx->hi2c = hi2c;
	ctx->height = height;
	ctx->screen = screen;
	ctx->column_shift = column_shift;
}
